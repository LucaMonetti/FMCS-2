// Events

controllable event M1_start;
uncontrollable event M1_finish_success;
uncontrollable event M1_brokendown;

controllable event M1_repaired;
controllable event M2_start;
uncontrollable event M2_finish_success;
uncontrollable event M2_brokendown;

controllable event M2_repaired;
controllable event M3_start;
uncontrollable event M3_finish_success;
uncontrollable event M3_brokendown;

controllable event M3_repaired;
controllable event BRMoveUp;
controllable event BRMoveDown;
controllable event BRMoveLeft;
controllable event BRMoveRight;

controllable event BRTake0;
controllable event BRTake1;
controllable event BRTake2;
controllable event BRTake3;

controllable event BRDeliver3;

controllable event BRCharge;
controllable event ORMoveUp;
controllable event ORMoveDown;
controllable event ORMoveLeft;
controllable event ORMoveRight;
controllable event ORCharge;

// Helpers

func int[0..10] distance(int[0..7] x1; int[0..5] y1; int[1..6] x2; int[1..4] y2):
    return abs(x1 - x2) + abs(y1 - y2);
end

func bool validMove(int[0..7] x; int[0..5] y; int[-1..7] energy):
    return distance(x, y, Charger1_x, Charger1_y) <= energy or distance(x, y, Charger2_x, Charger2_y) <= energy;
end

const int Charger1_x = 3;
const int Charger1_y = 4;

const int Charger2_x = 4;
const int Charger2_y = 1;

const int M1_x = 3;
const int M1_y = 3;

const int M2_x = 5;
const int M2_y = 3;

const int M3_x = 2;
const int M3_y = 2;

const int Source_x = 2;
const int Source_y = 4;

const int Target_x = 6;
const int Target_y = 1;

// Machine 1

svgfile "../plant.svg";

plant M1:

    location idle: marked; initial;
        edge M1_start goto working;

    location working:
        edge M1_finish_success goto idle;
        edge M1_brokendown goto broken;

    location broken:
        edge M1_repaired goto idle;

end

svgout id "M1-Frame" attr "fill" value if M1.idle : "#07BEB8" elif M1.broken : "#D92020" else "#E8871E" end;
svgout id "M1-Item" attr "display" value if M1.working : "inline" else "none" end;

// Machine 2

plant M2:

    location idle: marked; initial;
        edge M2_start goto working;

    location working:
        edge M2_finish_success goto idle;
        edge M2_brokendown goto broken;

    location broken:
        edge M2_repaired goto idle;

end

svgout id "M2-Frame" attr "fill" value if M2.idle : "#07BEB8" elif M2.broken : "#D92020" else "#E8871E" end;
svgout id "M2-Item" attr "display" value if M2.working : "inline" else "none" end;

// Machine 3

plant M3:

    location idle: marked; initial;
        edge M3_start goto working;

    location working:
        edge M3_finish_success goto idle;
        edge M3_brokendown goto broken;

    location broken:
        edge M3_repaired goto idle;

end

svgout id "M3-Frame" attr "fill" value if M3.idle : "#07BEB8" elif M3.broken : "#D92020" else "#E8871E" end;
svgout id "M3-Item" attr "display" value if M3.working : "inline" else "none" end;

// Blue Rover
plant BlueRover:

    disc int[1..6] x = 5;
    disc int[1..4] y = 1;

    disc int[0..8] energy = 8;

    disc int[0..2] wi0 = 0;
    disc int[0..2] wi1 = 0;
    disc int[0..2] wi2 = 0;
    disc int[0..2] wi3 = 0;

    location: marked; initial;
        edge BRMoveUp when y <= 3 and energy >= 1 and validMove(x, y + 1, energy - 1) do y := y + 1, energy := energy- 1;
        edge BRMoveDown when y >= 2 and energy >= 1 and validMove(x, y - 1, energy - 1) do y := y - 1, energy := energy- 1;
        edge BRMoveRight when x <= 5 and energy >= 1 and validMove(x + 1, y, energy - 1) do x := x + 1, energy := energy- 1;
        edge BRMoveLeft when x >= 2 and energy >= 1 and validMove(x - 1, y, energy - 1) do x := x - 1, energy := energy- 1;

        edge BRTake0 when x = 1 and y = 4 and wi0 < 2 do wi0 := wi0 + 1;
        edge BRTake1 when x = 3 and y = 3 and wi1 < 2 do wi1 := wi1 + 1;
        edge BRTake2 when x = 5 and y = 2 and wi2 < 2 do wi2 := wi2 + 1;
        edge BRTake3 when x = 1 and y = 1 and wi3 < 2 do wi3 := wi3 + 1;

        edge BRCharge when (x = 4 and y = 1) or (x = 3 and y = 4) do energy := 8;

        edge BRDeliver3 when x= 6 and y = 1 and wi3 >= 1 do wi3 := wi3 - 1;
end

// Update position

svgout id "BR-X-Pos" text value BlueRover.x;
svgout id "BR-Y-Pos" text value BlueRover.y;

// Update Energy

svgout id "BR-L1" attr "display" value if BlueRover.energy >= 1 : "inline" else "none" end;
svgout id "BR-L2" attr "display" value if BlueRover.energy >= 2 : "inline" else "none" end;
svgout id "BR-L3" attr "display" value if BlueRover.energy >= 3 : "inline" else "none" end;
svgout id "BR-L4" attr "display" value if BlueRover.energy >= 4 : "inline" else "none" end;
svgout id "BR-L5" attr "display" value if BlueRover.energy >= 5 : "inline" else "none" end;
svgout id "BR-L6" attr "display" value if BlueRover.energy >= 6 : "inline" else "none" end;
svgout id "BR-L7" attr "display" value if BlueRover.energy >= 7 : "inline" else "none" end;
svgout id "BR-L8" attr "display" value if BlueRover.energy = 8 : "inline" else "none" end;

// Update Carry
svgout id "Item-00" attr "display" value if BlueRover.wi0 >= 1 : "inline" else "none" end;
svgout id "Item-01" attr "display" value if BlueRover.wi0 = 2 : "inline" else "none" end;
svgout id "Item-10" attr "display" value if BlueRover.wi1 >= 1 : "inline" else "none" end;
svgout id "Item-11" attr "display" value if BlueRover.wi1 = 2 : "inline" else "none" end;
svgout id "Item-20" attr "display" value if BlueRover.wi2 >= 1 : "inline" else "none" end;
svgout id "Item-21" attr "display" value if BlueRover.wi2 = 2 : "inline" else "none" end;
svgout id "Item-30" attr "display" value if BlueRover.wi3 >= 1 : "inline" else "none" end;
svgout id "Item-31" attr "display" value if BlueRover.wi3 = 2 : "inline" else "none" end;

// Update Position

svgout id "B-Rover" attr "transform" value fmt("translate(%d, %d)", 52 + 207 * (BlueRover.x - 1), 135 + 207 * (4 - BlueRover.y));

// Orange Rover
plant OrangeRover:

    disc int[1..6] x = 3;
    disc int[1..4] y = 2;

    disc int[0..8] energy = 8;

    location: marked; initial;
        edge ORMoveUp when y <= 3 and energy >= 1 and validMove(x, y + 1, energy - 1) do y := y + 1, energy := energy- 1;
        edge ORMoveDown when y >= 2 and energy >= 1 and validMove(x, y - 1, energy - 1) do y := y - 1, energy := energy- 1;
        edge ORMoveRight when x <= 5 and energy >= 1 and validMove(x + 1, y, energy - 1) do x := x + 1, energy := energy- 1;
        edge ORMoveLeft when x >= 2 and energy >= 1 and validMove(x - 1, y, energy - 1) do x := x - 1, energy := energy- 1;

        edge ORCharge when (x = 4 and y = 1) or (x = 3 and y = 4) do energy := 8;

        edge M1_repaired when x = 3 and y = 3;
        edge M2_repaired when x = 5 and y = 2;
        edge M3_repaired when x = 1 and y = 1;

end

svgout id "OR-X-Pos" text value OrangeRover.x;
svgout id "OR-Y-Pos" text value OrangeRover.y;

svgout id "OR-L1" attr "display" value if OrangeRover.energy >= 1 : "inline" else "none" end;
svgout id "OR-L2" attr "display" value if OrangeRover.energy >= 2 : "inline" else "none" end;
svgout id "OR-L3" attr "display" value if OrangeRover.energy >= 3 : "inline" else "none" end;
svgout id "OR-L4" attr "display" value if OrangeRover.energy >= 4 : "inline" else "none" end;
svgout id "OR-L5" attr "display" value if OrangeRover.energy >= 5 : "inline" else "none" end;
svgout id "OR-L6" attr "display" value if OrangeRover.energy >= 6 : "inline" else "none" end;
svgout id "OR-L7" attr "display" value if OrangeRover.energy >= 7 : "inline" else "none" end;
svgout id "OR-L8" attr "display" value if OrangeRover.energy = 8 : "inline" else "none" end;

// Update Position

svgout id "O-Rover" attr "transform" value fmt("translate(%d, %d)", 92 + 207 * (OrangeRover.x - 1), 144 + 207 * (4 - OrangeRover.y));


// Depot 1
plant D1:

    disc int[0..2] quantity = 0;

    location : marked; initial;
        edge M1_finish_success when quantity < 2 do quantity := quantity + 1;
        edge BRTake1 when quantity > 0 do quantity := quantity - 1;

end

svgout id "D1-Item-1" attr "display" value if D1.quantity >= 1 : "inline" else "none" end;
svgout id "D1-Item-2" attr "display" value if D1.quantity = 2 : "inline" else "none" end;

// Depot 2
plant D2:

    disc int[0..2] quantity = 0;

    location : marked; initial;
        edge M2_finish_success when quantity < 2 do quantity := quantity + 1;
        edge BRTake2 when quantity > 0 do quantity := quantity - 1;

end

svgout id "D2-Item-1" attr "display" value if D2.quantity >= 1 : "inline" else "none" end;
svgout id "D2-Item-2" attr "display" value if D2.quantity = 2 : "inline" else "none" end;

// Depot 3
plant D3:

    disc int[0..2] quantity = 0;

    location : marked; initial;
        edge M3_finish_success when quantity < 2 do quantity := quantity + 1;
        edge BRTake3 when quantity > 0 do quantity := quantity - 1;

end

svgout id "D3-Item-1" attr "display" value if D3.quantity >= 1 : "inline" else "none" end;
svgout id "D3-Item-2" attr "display" value if D3.quantity = 2 : "inline" else "none" end;
